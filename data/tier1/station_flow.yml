version: "3.1"

flows:
  find_station:

    description: User wants to find nearest battery swap station or station location
    name: Station Finder Flow
    nlu_trigger:
      - intent: find_nearest_station

    steps:
      - id: "start"
        action: action_find_nearest_stations
        next:
          - if: slots.nearest_stations is not none
            then: "show_stations"
          - else: "ask_location"

      - id: "ask_location"
        collect: user_location
        description: Collect user's location if geolocation failed
        next: "find_stations_with_location"
        utter: utter_ask_location

      - id: "find_stations_with_location"
        action: action_find_nearest_stations
        next: "show_stations"

      - id: "show_stations"
        action: utter_nearest_stations
        next: "ask_availability"

      - id: "ask_availability"
        action: utter_ask_check_availability
        next: "wait_availability_response"

      - id: "wait_availability_response"
        collect: wants_availability
        next:
          - if: slots.wants_availability == "yes"
            then: "check_availability"
          - else: "end_flow"

      - id: "check_availability"
        action: action_check_station_availability
        next: "show_availability"

      - id: "show_availability"
        action: utter_station_availability
        next: "end_flow"

      - id: "end_flow"
        action: utter_anything_else

  check_availability:
    description: User wants to check battery availability at a specific station
    name: Station Availability Flow
    nlu_trigger:
      - intent: check_station_availability

    steps:
      - id: "start"
        collect: station_identifier
        description: Collect station name or code
        next: "fetch_availability"
        ask_before_filling: true
        utter: utter_ask_station_name

      - id: "fetch_availability"
        action: action_check_station_availability
        next: "show_availability"

      - id: "show_availability"
        action: utter_station_availability
        next: "end_flow"

      - id: "end_flow"
        action: utter_anything_else